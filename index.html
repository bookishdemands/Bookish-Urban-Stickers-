<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bookish Demands Sticker Vault</title>

  <style>
    :root{
      --bg:#0f0f14;
      --panel: rgba(255,255,255,.04);
      --line: rgba(255,255,255,.10);
      --text:#f3f3f7;
      --muted:#a9a9b7;
      --accent:#ff4fa3;
      --shadow: 0 12px 34px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 0%, rgba(255,79,163,.18), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(32,227,178,.14), transparent 55%),
        radial-gradient(900px 500px at 40% 110%, rgba(255,205,115,.10), transparent 55%),
        var(--bg);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px 16px 60px}
    header{display:flex;flex-wrap:wrap;align-items:flex-end;justify-content:space-between;gap:14px;margin-bottom:16px}
    h1{margin:0;font-size:clamp(22px,3.2vw,34px);letter-spacing:.2px}
    .subtitle{color:var(--muted);line-height:1.35;max-width:92ch;margin-top:6px}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px;margin-top:18px}
    @media (max-width: 940px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .cardHead{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.07);display:flex;align-items:center;justify-content:space-between;gap:10px}
    .cardHead h2{margin:0;font-size:14px;letter-spacing:.6px;text-transform:uppercase;color:rgba(243,243,247,.9)}
    .mini{
      font-family:var(--mono);
      font-size:11.5px;
      color:rgba(243,243,247,.85);
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius:999px;padding:6px 10px;white-space:nowrap
    }
    .cardBody{padding:14px 16px 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
    @media (max-width:520px){.row{grid-template-columns:1fr}}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select,input[type="text"],textarea{
      width:100%;padding:10px 11px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.25);color:var(--text);outline:none
    }
    textarea{min-height:118px;font-family:var(--mono);font-size:12.5px;line-height:1.35;resize:vertical}
    .toggle{
      display:flex;align-items:flex-start;gap:10px;padding:10px 11px;border-radius:12px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);color:var(--muted);user-select:none
    }
    .toggle input{width:18px;height:18px;margin-top:2px}
    .buttons{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{
      border:0;border-radius:999px;padding:11px 14px;font-weight:900;letter-spacing:.15px;cursor:pointer;
      color:#0f0f14;background:linear-gradient(135deg,var(--accent),#ffcc73);box-shadow:0 10px 25px rgba(255,79,163,.18)
    }
    button.secondary{background:rgba(255,255,255,.08);color:var(--text);border:1px solid rgba(255,255,255,.12);box-shadow:none}
    button.ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18);box-shadow:none}
    button:active{transform:translateY(1px)}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
    .hint{color:var(--muted);font-size:12px;line-height:1.45;margin-top:8px}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(20,20,30,.92);border:1px solid rgba(255,255,255,.12);color:var(--text);
      padding:10px 12px;border-radius:999px;font-size:12px;opacity:0;pointer-events:none;
      transition:opacity .18s ease;box-shadow:var(--shadow);max-width:calc(100vw - 24px);
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;z-index:9999
    }
    .toast.show{opacity:1}
    .bankGrid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.bankGrid{grid-template-columns:1fr}}
    .bankBox{
      padding:10px 11px;border:1px solid var(--line);border-radius:14px;background:rgba(0,0,0,.16)
    }
    .bankTitle{font-size:12px;color:rgba(243,243,247,.9);font-weight:900;letter-spacing:.5px;margin-bottom:8px}
    .checkRow{display:flex;gap:10px;align-items:flex-start;color:var(--muted);padding:6px 0}
    .checkRow input{width:18px;height:18px;margin-top:2px}
    .footerNote{margin-top:14px;color:var(--muted);font-size:12px;line-height:1.5}
    .footerNote b{color:var(--text)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Bookish Demands Sticker Vault</h1>
        <div class="subtitle">
          Ideogram-ready sticker prompt engine for <b>Urban Fiction</b>, <b>Dark Romance</b>, <b>Black Paranormal</b>, <b>Black Romance</b>, <b>Thriller</b>, <b>Fantasy</b>, and <b>Horror</b>.
          Includes <b>harmony</b>, <b>presets</b>, <b>cut-safe mode</b>, <b>custom inputs</b>, and a big <b>witty urban bookish quote bank</b>.
        </div>
      </div>
      <div class="mini" id="statusPill">Ready</div>
    </header>

    <div class="grid">
      <!-- INPUTS -->
      <section class="card">
        <div class="cardHead">
          <h2>Inputs</h2>
          <span class="mini">Random picks 1‚Äì2 banks max ‚úÖ</span>
        </div>
        <div class="cardBody">

          <div class="row">
            <div>
              <label for="count">How many prompts?</label>
              <select id="count">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
                <option value="5">5</option>
              </select>
            </div>

            <div>
              <label for="stickerType">Sticker Type</label>
              <select id="stickerType">
                <option value="packaging" selected>Packaging Label Sticker (like reference)</option>
                <option value="icon_quote">Icon + Quote</option>
                <option value="icon_only">Icon Only (no text)</option>
                <option value="quote_only">Quote Only (typography sticker)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="genreTone">Genre Tone (None allowed)</label>
              <select id="genreTone">
                <option value="">None</option>
                <option value="urban_fiction">Urban Fiction</option>
                <option value="dark_romance">Dark Romance</option>
                <option value="black_paranormal">Black Paranormal Romance</option>
                <option value="black_romance">Black Romance</option>
                <option value="thriller">Thriller</option>
                <option value="fantasy">Fantasy</option>
                <option value="horror">Horror</option>
                <option value="soft_glam_reader">Soft Glam Reader</option>
                <option value="bookish_luxe">Bookish Luxe</option>
              </select>
            </div>

            <div>
              <label for="variation">Variation (mood/style/aesthetic)</label>
              <select id="variation">
                <option value="">None</option>
                <option value="bold_vector">Bold Vector Sticker</option>
                <option value="cute_clipart">Cute Flat Clipart</option>
                <option value="hand_doodle">Hand-Doodle Charm</option>
                <option value="hand_drawn">Hand-Drawn (Ink Sketch) ‚úÖ</option>
                <option value="booktok_pop">BookTok Pop-Art</option>
                <option value="noir_minimal">Noir Minimal</option>
                <option value="neon_noir">Neon Noir</option>
                <option value="luxury_editorial">Luxury Editorial</option>
                <option value="vintage_label">Vintage Apothecary Label</option>
                <option value="kawaii_goth">Kawaii Goth</option>
              </select>
            </div>
          </div>

          <div class="row">
            <label class="toggle" style="grid-column:1/-1;">
              <input id="handDrawnPreset" type="checkbox" />
              <div><b>Hand-Drawn preset</b> (quick toggle ‚Äî sets variation to Hand-Drawn + keeps sticker-ready clarity)</div>
            </label>
          </div>

          <div class="row">
            <div>
              <label for="vibe">Vibe (None allowed)</label>
              <select id="vibe">
                <option value="">None</option>
                <option>Street Luxe Romance</option>
                <option>Midnight Confessions</option>
                <option>Forbidden Attraction</option>
                <option>Jealous Enemy Plot</option>
                <option>Protective Possessive Energy</option>
                <option>Booktrovert Peace Mode</option>
                <option>Kindle After Dark</option>
                <option>Morally Gray Glam</option>
                <option>Thriller ‚Äî Cold Case Energy</option>
                <option>Fantasy ‚Äî Divine & Dangerous</option>
                <option>Witchy City Glam</option>
                <option>Coven Chic</option>
                <option>Luxury Reader Baddie</option>
                <option>Intellectual Villain Era</option>
                <option>Soft Life But Savage</option>
                <option>Mood: quotes</option>
                <option>IYKYK</option>
                <option>Remaining in Bookland until further notice</option>
                <option>Audiobook Era</option>
                <option>This book ruined me‚Ä¶ 5 stars</option>
                <option>In my ‚Äú___‚Äù era</option>
                <option>DBE: ___ ‚Ä¶ 5 stars</option>
                <option>Slow Burn Season</option>
                <option>Ugly Cry Certified</option>
                <option>STFUATTDLAGG energy</option>
              </select>
            </div>

            <div>
              <label for="productTheme">Packaging / Product Theme (None allowed)</label>
              <select id="productTheme">
                <option value="">None</option>

                <!-- Existing -->
                <option value="iv_bag">IV Bag</option>
                <option value="pill_bottle">Pill Bottle (non-IV)</option>
                <option value="prescription_pad">Prescription Pad</option>
                <option value="heart_monitor">Heart Monitor Strip</option>
                <option value="toe_tag">Toe Tag (thriller-coded)</option>
                <option value="seasoning">Seasoning Jar</option>
                <option value="hot_sauce">Hot Sauce Bottle</option>
                <option value="honey_jar">Honey Jar</option>
                <option value="juice_bottle">Juice Bottle</option>
                <option value="energy_drink">Energy Drink Can</option>
                <option value="candy">Candy Wrapper</option>

                <!-- NEW (your list) -->
                <option value="door_tag">Door Tag (Do Not Disturb)</option>
                <option value="name_tag">Name Tag (Hello, I Am‚Ä¶)</option>
                <option value="library_card">Library Card / Checkout Slip</option>
                <option value="guest_check">Guest Check</option>
                <option value="tbr_receipt">TBR Receipt</option>
                <option value="spice_meter">Spice Scale Meter</option>
                <option value="delulu_meter">Delulu Meter</option>
                <option value="ugly_cry_meter">Ugly Cry Meter</option>
                <option value="horror_scale">Horror Reader Scale</option>
                <option value="caution_sign">Caution Sign</option>
                <option value="phone_dnd">Phone (DND Screen)</option>
                <option value="sticky_memos">Sticky Memos</option>
                <option value="fortune_cookie">Fortune Cookie</option>
                <option value="magic_8_ball">Magic 8 Ball</option>
                <option value="glass_fortune_ball">Glass Fortune Ball</option>
                <option value="bp_monitor">Blood Pressure Monitor</option>
                <option value="book_review_card">Book Review Card (5 Stars)</option>
                <option value="elixir_bottle">Elixir / Potion Bottle</option>

                <option value="wax_seal_stamp">Wax Seal Stamp Kit</option>
                <option value="candle_spell_jar">Candle Jar / Spell Candle</option>
                <option value="matchbook">Matchbook / Matchbox</option>
                <option value="polaroid_frame">Polaroid Photo Frame</option>
                <option value="nail_polish">Nail Polish Bottle</option>
                <option value="coffee_cup">Coffee / Iced Coffee / Tea</option>
                <option value="specimen_vial">Lab Specimen Vial (Evidence)</option>
                <option value="evidence_tag">Evidence Tag + Barcode</option>
                <option value="tarot_card">Tarot Card Pack (Original)</option>
                <option value="bookmark_sneaker_lace">Bookmark + Sneaker Lace Combo</option>
                <option value="book_stack_tropes">Stack of Books (Tropes on Spines)</option>
                <option value="confession_note">Confession Note</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="palette">Color Palette (None allowed)</label>
              <select id="palette"></select>
            </div>
            <div>
              <label for="bgMode">Background</label>
              <select id="bgMode">
                <option value="transparent" selected>Transparent background</option>
                <option value="solid_white">Solid white background</option>
                <option value="none_specified">Don‚Äôt specify</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="border">Sticker Border</label>
              <select id="border">
                <option value="white" selected>White border (recommended)</option>
                <option value="none">No border</option>
              </select>
            </div>
            <div>
              <label for="outline">Outline</label>
              <select id="outline">
                <option value="bold_black" selected>Thick bold outline</option>
                <option value="no_outline">No outline</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="spiceLevel">Spice Level (1‚Äì5)</label>
              <select id="spiceLevel">
                <option value="1">1 ‚Äî sweet tension</option>
                <option value="2">2 ‚Äî flirty heat</option>
                <option value="3" selected>3 ‚Äî spicy vibes</option>
                <option value="4">4 ‚Äî dark romance heat (non-graphic)</option>
                <option value="5">5 ‚Äî filthy talk energy (non-graphic)</option>
              </select>
            </div>
            <div>
              <label for="typoRule">Typography Rules</label>
              <select id="typoRule">
                <option value="on" selected>Enforce: clear legible typography</option>
                <option value="off">Don‚Äôt specify typography rules</option>
              </select>
            </div>
          </div>

          <div class="row">
            <label class="toggle" style="grid-column:1/-1;">
              <input id="blankMode" type="checkbox" />
              <div><b>Blank sticker mode</b> (no label/quote text at all ‚Äî useful for icon packs)</div>
            </label>
          </div>

          <div class="row">
            <label class="toggle" style="grid-column:1/-1;">
              <input id="cutSafeMode" type="checkbox" checked />
              <div><b>Cut-safe mode</b> (contain smoke/sparkles/glow/particles <b>INSIDE</b> the die-cut silhouette ‚Äî default ON)</div>
            </label>
          </div>

          <div class="row">
            <div>
              <label for="labelMode">Label Text Mode</label>
              <select id="labelMode">
                <option value="none">No label text</option>
                <option value="auto" selected>Auto label title + subtitle</option>
                <option value="manual">Use my Title + Subtitle</option>
                <option value="mixed">Manual if provided, otherwise Auto</option>
                <option value="quote_subtitle">Quote as Subtitle (title auto)</option>
              </select>
            </div>
            <div>
              <label for="quoteMode">Quote Mode</label>
              <select id="quoteMode">
                <option value="any" selected>Any</option>
                <option value="micro">Micro (2‚Äì5 words)</option>
                <option value="standard">Standard (witty lines)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="titleText">Title (optional)</label>
              <input id="titleText" type="text" maxlength="60" placeholder='Example: "EMERGENCY ROMANCE SUPPLY"' />
            </div>
            <div>
              <label for="subtitleText">Subtitle (optional)</label>
              <input id="subtitleText" type="text" maxlength="90" placeholder='Example: "99% Delulu ‚Ä¢ 1% Regret"' />
            </div>
          </div>

          <div class="row">
            <label class="toggle" style="grid-column:1/-1;">
              <input id="useRandomQuote" type="checkbox" checked />
              <div><b>Use random quote</b> (you can still type a quote to override)</div>
            </label>
          </div>

          <div class="row">
            <div>
              <label for="quote">Quote (optional override)</label>
              <input id="quote" type="text" maxlength="140" placeholder='Example: "Possessive Energy Only."' />
            </div>
            <div>
              <label for="quoteUsage">Quote usage</label>
              <select id="quoteUsage">
                <option value="smart" selected>Smart (depends on sticker type)</option>
                <option value="always">Always include quote (if not blank)</option>
                <option value="never">Never include quote line</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div>
              <label for="customMainObject">Custom Main Object (optional)</label>
              <input id="customMainObject" type="text" maxlength="120" placeholder='Example: "sparkly Kindle + sneaker charm"' />
            </div>
            <div>
              <label for="customVibe">Custom Vibe (optional)</label>
              <input id="customVibe" type="text" maxlength="120" placeholder='Example: "Midnight Book Bae Energy"' />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="customPalette">Custom Palette (optional)</label>
              <input id="customPalette" type="text" maxlength="120" placeholder='Example: "neon pink + espresso brown + chrome"' />
            </div>
            <div>
              <label for="customAccents">Custom Accents (optional)</label>
              <input id="customAccents" type="text" maxlength="120" placeholder='Example: "gold foil flecks + glitter dots"' />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="customProductTheme">Custom Product Theme (optional)</label>
              <input id="customProductTheme" type="text" maxlength="120" placeholder='Example: "love potion dropper bottle label sticker"' />
            </div>
            <div>
              <label for="customQuotes">Custom Quote Bank (optional ‚Äî one per line)</label>
              <textarea id="customQuotes" placeholder="Add your own quotes here. If filled, random quotes will pull from here first."></textarea>
            </div>
          </div>

          <div class="divider"></div>

          <div class="bankGrid">
            <div class="bankBox">
              <div class="bankTitle">CORE (Random picks 1‚Äì2 max)</div>

              <label class="checkRow">
                <input type="checkbox" id="bGeneralUrbanBookish" checked>
                <span>General Urban Bookish</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="bTBRKindleBooktok">
                <span>TBR / Kindle / BookTok</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="bMorallyGray">
                <span>Morally Gray (toggle)</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="bUnhingedMMC">
                <span>Unhinged MMC (possessive/protective)</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="bStreetLingo">
                <span>Street / Urban Lingo</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="bTropes">
                <span>BookTok Tropes (reverse harem, age-gap, wealthy MMC, etc.)</span>
              </label>
            </div>

            <div class="bankBox">
              <div class="bankTitle">GENRES (Quote flavor toggles)</div>

              <label class="checkRow">
                <input type="checkbox" id="gUrbanFiction">
                <span>Urban Fiction</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gBlackRomance">
                <span>Black Romance</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gDarkRomance">
                <span>Dark Romance (non-graphic)</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gBlackParanormal">
                <span>Black Paranormal Romance</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gThriller">
                <span>Thriller / Suspense</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gFantasy">
                <span>Fantasy</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gHorror">
                <span>Horror</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gBookishLuxe">
                <span>Bookish Luxe</span>
              </label>

              <label class="checkRow">
                <input type="checkbox" id="gSoftGlam">
                <span>Soft Glam Reader</span>
              </label>
            </div>
          </div>

          <div class="buttons">
            <button id="generateBtn">Generate</button>
            <button class="secondary" id="copyBtn">Copy Prompt</button>
            <button class="ghost" id="randomBtn">Randomize</button>
            <button class="ghost" id="clearBtn">Clear All</button>
          </div>

          <div class="hint">
            <b>Cut-safe mode</b> forces the prompt to request a single closed die-cut silhouette and tells the model that <b>ALL accents</b> must stay inside the outline.
            <br/>üß† Harmony: choosing <b>Horror</b> will auto-bias palettes toward <b>red/black</b> when you leave palette blank.
          </div>
        </div>
      </section>

      <!-- OUTPUTS -->
      <section class="card">
        <div class="cardHead">
          <h2>Outputs</h2>
          <span class="mini">Ideogram-ready ‚úÖ</span>
        </div>
        <div class="cardBody">
          <div style="margin-bottom:12px;">
            <label for="promptOut">Prompt</label>
            <textarea id="promptOut" readonly></textarea>
          </div>

          <div style="margin-bottom:12px;">
            <label for="negOut">Negative Prompt</label>
            <textarea id="negOut" readonly></textarea>
          </div>

          <div>
            <label for="notesOut">Export Notes</label>
            <textarea id="notesOut" readonly></textarea>
          </div>

          <div class="footerNote">
            <b>Commercial safety:</b> keep it original ‚Äî avoid brand names/logos, real book titles, celebrity likeness, and copyrighted characters.
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast">Copied!</div>

  <script>
    // ---------- DOM helpers ----------
    const $ = (id)=>document.getElementById(id);
    const v = (id)=>($(id)?.value ?? "");
    const setV = (id,val)=>{ if($(id)) $(id).value = val; };
    const c = (id)=>!!($(id)?.checked);
    const setC = (id,val)=>{ if($(id)) $(id).checked = !!val; };

    function showToast(msg){
      const t = $("toast");
      if(!t) return;
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 1100);
    }
    function setStatus(msg){
      const p = $("statusPill");
      if(p) p.textContent = msg;
    }
    const rndInt = (n)=>Math.floor(Math.random()*n);
    const pick = (arr)=>arr[rndInt(arr.length)];
    const uniq = (arr)=>Array.from(new Set(arr));

    // ---------- Variations ----------
    const VARIATIONS = {
      bold_vector: "bold vector sticker, thick clean lines, high-contrast shapes, sharp vector clarity, premium sticker look",
      cute_clipart: "cute flat vector clipart sticker, rounded shapes, clean flat shading, crisp edges, commercial clipart style",
      hand_doodle: "hand-drawn doodle sticker style, thick outline, simple flat shading, charming imperfections (but clean)",
      hand_drawn: "hand-drawn illustration style, sketchy ink outlines, playful imperfect strokes, doodle aesthetic, still crisp and sticker-ready, vector-like clarity",
      booktok_pop: "booktok pop-art sticker style, bold shapes, punchy contrast, crisp outlines",
      noir_minimal: "noir minimal sticker, simple shapes, limited details, strong contrast, modern minimal icon",
      neon_noir: "neon noir sticker, subtle neon glow accents, dark subject, high contrast highlights (glow contained inside silhouette)",
      luxury_editorial: "luxury editorial sticker aesthetic, polished highlights, premium glam details, clean upscale feel",
      vintage_label: "vintage apothecary label sticker style, ornate frame details, bold readable label text (still clean)",
      kawaii_goth: "kawaii goth sticker style, cute + dark contrast, tiny hearts, subtle spooky accents, clean vector finish"
    };

    // ---------- Palettes ----------
    const PALETTES = [
      "Grey + Red + Black",
      "Obsidian + Molten Gold + Smoke Gray",
      "Black Cherry + Gunmetal + Chrome",
      "Midnight Blue + Emerald + Gold",
      "Burgundy Wine + Antique Gold + Espresso",
      "Deep Plum + Rose Gold + Charcoal",
      "Black + Ruby + Liquid Silver",
      "Sapphire + Jet Black + Platinum",
      "Cream + Warm Brown + Gold",
      "Ivory + Espresso + Rose Gold",
      "Blush Pink + Cocoa + Cream",
      "Rose Gold + Mauve + Champagne",
      "Dusty Rose + Mocha + Gold",
      "Amethyst + Midnight + Silver",
      "Teal + Obsidian + Violet Glow",
      "Forest Green + Black + Moonlight Silver",
      "Neon Pink + Black + Chrome",
      "Electric Blue + Hot Pink + Black",
      "Acid Green + Black + Silver",
      "Orange + Royal Blue + Black",
      "Metallic Silver + Bubblegum + Black",
      "Aqua + Deep Purple + Neon Yellow",
      "White + Black + Chrome",
      "Light Gray + Black + Platinum",
      "Copper + Black + Ember Glow",
      "Blood Red + Ink + Steel",
      "Burnt Orange + Charcoal + Gold",
      "Galaxy Blue + Violet + Star White",
      "Lavender + Soft Gold + Ivory",
      "Peach + Nude + Warm Brown",
      "Tangerine + Purple + White",
      // extra horror-friendly options (safe additions)
      "Crimson + Black + Chrome",
      "Cherry Red + Jet Black + Silver"
    ];

    const HORROR_PALETTES = [
      "Grey + Red + Black",
      "Blood Red + Ink + Steel",
      "Crimson + Black + Chrome",
      "Black Cherry + Gunmetal + Chrome",
      "White + Black + Chrome"
    ];

    function loadPalettes(){
      const sel = $("palette");
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = "None";
      sel.appendChild(opt0);
      PALETTES.forEach(p=>{
        const o=document.createElement("option");
        o.value=p; o.textContent=p;
        sel.appendChild(o);
      });
    }

    // ---------- Product descriptions ----------
    const PRODUCT_DESC = {
      // existing
      iv_bag: "IV drip bag sticker illustration (generic medical bag shape), hanging with tube, clamp, drip chamber, glossy liquid fill; clean label panel area for text; no hospital branding",
      pill_bottle: "prescription pill bottle sticker (non-IV), rounded amber bottle with childproof cap and clean label panel; a few stylized pills nearby; no pharmacy branding",
      prescription_pad: "prescription pad / Rx notepad sticker with tear-off sheets; clean header blocks; no clinic branding",
      heart_monitor: "heart monitor strip sticker, ECG waveform display or paper strip look with clean monitor frame; readable label panel",
      toe_tag: "toe tag sticker (generic evidence/morgue tag) with string loop and bold label blocks; thriller-coded; no real case identifiers",
      seasoning: "generic seasoning jar sticker, spice shaker with flip-top lid; clean label panel; tiny spice specks",
      hot_sauce: "generic hot sauce bottle sticker, glass bottle with glossy shine; bold label panel; no brand marks",
      honey_jar: "generic honey jar sticker, golden honey fill with drip effect; clean label panel; no brand marks",
      juice_bottle: "generic juice bottle sticker, cute bottle silhouette with glossy highlights; bold label panel; no brand marks",
      energy_drink: "generic energy drink can sticker, slim aluminum can with metallic shine; bold label panel; no brand marks",
      candy: "generic candy wrapper sticker, shiny foil wrapper with twisted ends; bold label panel; no brand marks",

      // new product themes
      door_tag: "door hanger / do-not-disturb door tag sticker with bold headline and big centered quote area; simple icon accents; clean signage layout; no branding",
      name_tag: "name tag sticker (HELLO, I AM‚Ä¶) with bold name field and optional subtitle line; clean label blocks; no branding",
      library_card: "library checkout card / library card sticker with stamped due dates, barcode, and clean text fields; vintage checkout slip look; no real library branding",
      guest_check: "guest check / restaurant-style receipt sticker with table/date/check number fields; big handwritten quote in center; clean grid lines; no real restaurant branding",
      tbr_receipt: "store receipt-style sticker titled TBR RECEIPT, itemized tropes/reads list, subtotal/total lines, barcode, funny footer line; clean readable typography; no real store branding",

      spice_meter: "vertical spice scale / thermometer meter sticker with labeled levels and a slider indicator; playful icons; clean readable sections",
      delulu_meter: "vertical meter sticker labeled DELULU METER with levels from realistic to certified delulu; clean sections and indicator",
      ugly_cry_meter: "vertical meter sticker labeled UGLY CRY METER with escalating levels; tissues/tear icons; clean readable layout",
      horror_scale: "vertical horror reader scale meter sticker with levels from creepy-cozy to sleep-with-lights-on; subtle spooky icons; clean readable layout",

      caution_sign: "caution sign / hazard placard sticker with bold WARNING header and short spicy-safe text; clean signage style; no branding",
      phone_dnd: "smartphone screen sticker showing DND / notification banner style text; clean original UI-like layout (not a real brand UI); readable type",
      sticky_memos: "sticky memo note pad sticker with handwritten quote, tape corners or tab, doodle accents; clean high-contrast lettering",
      fortune_cookie: "fortune cookie sticker with a fortune strip showing a short quote; cute clean vector look; no branding",
      magic_8_ball: "magic 8 ball sticker with readable answer window and playful highlights; clean vector clarity",
      glass_fortune_ball: "glass crystal ball sticker on a small stand, faint glow contained inside silhouette; readable label panel; mystical vibe",
      bp_monitor: "blood pressure monitor sticker (digital screen + cuff icon) showing humorous reading-related status; clean readable screen",
      book_review_card: "book review card sticker with star rating row, short review quote, and ‚Äò5 stars‚Äô style layout; clean readable design",
      elixir_bottle: "elixir / potion bottle sticker (dropper or cork bottle) with label panel and sparkly fill; paranormal luxe vibe",

      wax_seal_stamp: "wax seal stamp kit sticker: wax seal imprint, stamp handle, and sealing wax; elegant label area; vintage luxe vibe",
      candle_spell_jar: "spell candle jar sticker (glass candle jar) with label panel; tiny sigils/sparkles contained inside border; no branding",
      matchbook: "matchbook / matchbox sticker with bold headline and short quote; matchstick icons; clean vintage pop look",
      polaroid_frame: "polaroid photo frame sticker with blank photo area and caption strip; clean border; no branding",
      nail_polish: "nail polish bottle sticker with glossy highlight, label panel, and tiny sparkles; clean silhouette; no branding",
      coffee_cup: "coffee cup / iced coffee / tea sticker with lid, straw (optional), label panel, condensation highlights; no branding",
      specimen_vial: "lab specimen vial sticker with barcode label and sparkly ‚Äòevidence‚Äô fill; clean lab aesthetic; no branding",
      evidence_tag: "evidence tag sticker (clean/cute) with barcode, case number fields, and short quote area; no real case identifiers",
      tarot_card: "original tarot card pack sticker (no copyrighted deck), ornate frame, title block, symbolic icon; clean readable typography",
      bookmark_sneaker_lace: "bookmark + sneaker lace combo sticker: cute bookmark tag paired with a stylized sneaker lace bow/loop; clever bookish + streetwear mashup; clean outlines",
      book_stack_tropes: "stack of books sticker with trope names on spines (bold readable), cute accents, clean outlines; no real titles/authors",
      confession_note: "confession note sticker with ‚ÄòCONFESSION:‚Äô header and bold handwritten quote; clean paper edges; cute dramatic vibe"
    };

    // Accents map (optional helpers). Cut-safe will clamp these in prompt.
    const DEFAULT_ACCENTS_BY_PRODUCT = {
      iv_bag: "gold foil flecks + glitter dots",
      elixir_bottle: "gold foil flecks + glitter dots",
      candle_spell_jar: "tiny sparkles + glitter dots",
      tarot_card: "tiny sparkles + ornate frame flourishes",
      book_review_card: "tiny star doodles + sparkle dots",
      book_stack_tropes: "tiny sparkles + small hearts",
      horror_scale: "inky specks + tiny sparkles"
    };

    function describeProductKey(){
      const custom = (v("customProductTheme")||"").trim();
      if(custom) return custom;
      const k = v("productTheme");
      if(!k) return "";
      return PRODUCT_DESC[k] || `packaging-style sticker illustration of ${k} with clean label panel`;
    }

    // ---------- Label banks ----------
    const LABEL_TITLES = {
      iv_bag: ["HEARTBREAK RECOVERY SOLUTION","EMERGENCY ROMANCE SUPPLY","THE GREY DOSE SUPPLY","MIDNIGHT OBSESSION DRIP","SOFT LIFE TRANSFUSION","MAIN CHARACTER SERUM","JEALOUSY ANTIDOTE","TRUST ISSUES TREATMENT"],
      pill_bottle: ["MORALLY GREY CAPSULES","BOOK BOYFRIEND PILLS","UNHINGED MMC TABLETS","TBR CONTROL MEDS","INTROVERT ENERGY CAPS","DELULU SUPPORT PILLS","CHAOS & CHEMISTRY RX"],
      prescription_pad: ["PRESCRIPTION: BAD DECISIONS","RX: SOFT ERA ONLY","RX: ONE MORE CHAPTER","RX: RESPECTFULLY, NO","RX: MAIN CHARACTER MODE","RX: READ & DISAPPEAR"],
      heart_monitor: ["HEART RATE: UNHINGED","PULSE CHECK: OBSESSED","STATUS: CHEMISTRY SPIKE","ALERT: BOOK BOYFRIEND","WARNING: FEELINGS DETECTED","STABILITY: NOT FOUND"],
      toe_tag: ["CAUSE OF DEATH: FEELINGS","PRONOUNCED: DOWN BAD","CASE FILE: HEART SNATCHED","EVIDENCE: TEXTS TOO SWEET","MOTIVE: BOOKISH OBSESSION","FILED UNDER: CHAOS"],
      seasoning: ["MAIN CHARACTER SEASONING","MORALLY GREY SPICE","UNHINGED MMC RUB","SOFT LIFE SPRINKLE","CITY-LIT HEAT","BOOKISH DUST"],
      hot_sauce: ["PROTECTIVE HEAT","OBSESSION HOT SAUCE","MORALLY GREY FIRE","UNHINGED DRIP","CITY-LIT SCORCH","MIDNIGHT FLAME"],
      honey_jar: ["SOFT LIFE HONEY","SWEET LIKE TROUBLE","BOOK BAE HONEY","MIDNIGHT GOLD","OBSESSION DRIZZLE","DANGEROUSLY SWEET"],
      juice_bottle: ["DELULU JUICE","SOFT LIFE SIP","CITY-LIT NECTAR","BOOK BAE BLEND","ROMANCE REFRESH","SPARKLE SQUEEZE"],
      energy_drink: ["ONE MORE CHAPTER ENERGY","UNHINGED MMC FUEL","PLOT TWIST POWER","BOOKTROVERT BOOST","TBR TURBO","MIDNIGHT HUSTLE"],
      candy: ["SWEET BUT TOXIC","DELULU DROPS","CHEMISTRY CHEWS","BOOK BAE BITES","MIDNIGHT MELTS","UNHINGED FLAVOR"],

      // new
      library_card: ["BOOKLAND RESIDENT","CHECKED OUT","DUE BACK: NEVER","LIBRARY FLIRT CARD","READER ON FILE"],
      guest_check: ["GUEST CHECK","BOOKSTORE DATE RECEIPT","LOVE + LITERATURE","TAB: PAID IN CHAPTERS"],
      tbr_receipt: ["TBR RECEIPT","RE-READ PURCHASE","BOOKTOK TAX","PLOT TWIST RECEIPT"],
      door_tag: ["DO NOT DISTURB","READING IN PROGRESS","IN BOOKLAND","NOT AVAILABLE"],
      name_tag: ["HELLO, I AM","READER STATUS","INTROVERT MODE","MAIN CHARACTER"],
      spice_meter: ["SPICE SCALE","CHEMISTRY CHECK","HEAT LEVELS"],
      delulu_meter: ["DELULU METER","REALITY CHECK","MANIFESTATION LEVELS"],
      ugly_cry_meter: ["UGLY CRY METER","TEAR LEVELS","EMOTIONAL DAMAGE"],
      horror_scale: ["HORROR SCALE","NO SLEEP CLUB","CREEPY COZY METER"],
      caution_sign: ["WARNING","CAUTION","PROCEED WITH FEELINGS"],
      phone_dnd: ["DND MODE","AIRPLANE MODE","SILENT MOVES"],
      sticky_memos: ["NOTE TO SELF","REMINDER","DO THIS AGAIN"],
      fortune_cookie: ["FORTUNE","READER PROPHECY","TODAY‚ÄôS SIGN"],
      magic_8_ball: ["MAGIC 8 BALL","ASK AGAIN","THE PLOT KNOWS"],
      glass_fortune_ball: ["FORTUNE BALL","THE VISION","SEEING CLEARLY"],
      bp_monitor: ["READING VITALS","PULSE CHECK","BP STATUS"],
      book_review_card: ["BOOK REVIEW","5 STAR REPORT","THIS RUINED ME"],
      elixir_bottle: ["LOVE ELIXIR","BOOKLAND TONIC","COVEN CHIC SERUM"],
      wax_seal_stamp: ["SEALED","COVEN SEAL","SIGNED & SEALED"],
      candle_spell_jar: ["SPELL CANDLE","PROTECTION CANDLE","LOVE WORK CANDLE"],
      matchbook: ["IGNITE ME","BURN AFTER READING","STRIKE A MATCH"],
      polaroid_frame: ["SNAPSHOT","MEMORY","PROOF OF CHEMISTRY"],
      nail_polish: ["GLOSS MODE","SOFT GLAM","READ & SLAY"],
      coffee_cup: ["BREW & READ","CAF + CHAPTERS","SIP & PLOT"],
      specimen_vial: ["EVIDENCE VIAL","CASE SAMPLE","SPARKLY PROOF"],
      evidence_tag: ["EVIDENCE TAG","CASE FILE","EXHIBIT A"],
      tarot_card: ["THE READER","THE PLOT TWIST","THE BOOK BOYFRIEND"],
      bookmark_sneaker_lace: ["MARK MY PAGE","LACED & BOOKED","BOOKISH DRIP"],
      book_stack_tropes: ["TROPE STACK","WHY CHOOSE","SLOW BURN STACK"],
      confession_note: ["CONFESSION","IYKYK","OFF THE RECORD"],
      default: ["MAIN CHARACTER ENERGY","PLOT TWIST PENDING","SOFT LIFE LOADING","LUXURY LOVE ONLY","DANGEROUS DESIRE","CITY-LIT CHAOS","GREY AREA ONLY"]
    };

    const LABEL_SUBS = {
      romance: ["99% Delulu ‚Ä¢ 1% Regret","Side effects: possessive energy","Dosage: one more chapter","Warning: may cause delulu","Results: immediate butterflies","Not FDA approved (but effective)"],
      thriller: ["Case status: open","Suspect: too charming","Evidence: unread texts","Warning: plot twist pending","Risk level: high","File under: chaos"],
      fantasy: ["Enchanted ‚Ä¢ do not dilute","Moonlit dosage only","Blessed by ancestors","Spellbound & sealed","Summon at midnight","Protected by wards"],
      paranormal: ["Not responsible for hauntings","Warning: soul ties possible","Night shift use only","Do not invite him in","Blood moon approved","Cloaked ‚Ä¢ keep secret"],
      luxe: ["Handle with care","Energy: expensive","Luxury love only","Polished & petty","Read it again","Keep it cute"],
      horror: ["No sleep club","Creepy cozy level: high","Lights on recommended","Do not read alone","If you know, you know","Plot twist: sinister"]
    };

    function subtitleSetForGenreTone(){
      const g = v("genreTone");
      if(g==="thriller") return "thriller";
      if(g==="fantasy") return "fantasy";
      if(g==="black_paranormal") return "paranormal";
      if(g==="horror") return "horror";
      if(g==="bookish_luxe") return "luxe";
      if(g==="soft_glam_reader") return "luxe";
      return "romance";
    }

    function getAutoLabel(){
      const productKey = v("productTheme") || "default";
      const titles = LABEL_TITLES[productKey] || LABEL_TITLES.default;
      const subs = LABEL_SUBS[subtitleSetForGenreTone()] || LABEL_SUBS.romance;
      return { title: pick(titles), subtitle: pick(subs) };
    }

    // ---------- Tropes (expanded, non-graphic) ----------
    const TROPE_LIBRARY = [
      "Billionaire / Wealthy MMC","Boss MMC","Celebrity MMC","Royalty MMC","Bodyguard MMC","Protector MMC",
      "Age Gap","Grumpy x Sunshine","Enemies to Lovers","Friends to Lovers","Forbidden Love","Slow Burn",
      "He Falls First","Touch Her & Die","Who Did This to You","Only One Bed","Fake Dating","Forced Proximity",
      "Morally Grey MMC","Anti-Hero MMC","Villain Gets the Girl","Second Chance Romance","Workplace Romance",
      "Single Dad MMC","Step-Daddy MMC (steps up as ideal father figure)","Found Family",
      "Reverse Harem / Why Choose","MMF","MFM","MMFMM","MMMF","MMMMF",
      "Witches","Vampires","Demons","Werewolves","Fae","Fated Mates","Soulmates","Cursed Lovers","Prophecy",
      "Audiobook Addict","Kindle Girlie","TBR Overload","5-Star Ruined Me","Ugly Cry Certified"
    ].map(t => `Trope: ${t}`);

    // ---------- Quote banks ----------
    const MICRO_QUOTES = [
      "Final Chapter Energy","Airplane Mode Activated","Kindle Confidential","TBR Supreme","Booktrovert Vibes",
      "Certified Delulu","Plot Twist Pending","Morals Optional","Grace With Teeth","Stand On Business",
      "No Face No Case","Energy Expensive","Act Right Only","Handle Correctly","Possessive Energy Only",
      "Soft But Savage","Pretty With Power","Reader In Charge","Do Not Disturb","Main Character Mood"
    ];

    const QUOTE_BANKS = {
      // CORE
      general_urban_bookish: [
        "Booked, Busy, Unavailable.","Reading Is My Love Language.","Respectfully, I‚Äôm In A Chapter.","If I Reply Late, Blame The Plot.",
        "I‚Äôm Not Ignoring You‚ÄîThe MMC Is.","My Peace Got Page Numbers.","Fictional Standards Only.","Text Me After The Epilogue.",
        "I Read That‚Ä¶ Don‚Äôt Ask Questions.","Keep It Cute, I‚Äôm Reading.","I Don‚Äôt Chase‚Äî I Turn Pages.","Plot Thickening, Don‚Äôt Call.",
        "I‚Äôm Outside‚Ä¶ In My Kindle.","Soft Life, Sharp Tongue.","I‚Äôm Sweet‚ÄîUntil The Plot Twists."
      ],
      tbr_kindle_booktok: [
        "My Kindle Know My Business.","My TBR Is A Lifestyle.","BookTok Made Me Do It.","Kindle History Stays Private.",
        "One More Chapter Is A Lie.","I‚Äôm In My Re-Read Era.","I Buy Books Like It‚Äôs Therapy.","My TBR Got A Mortgage.",
        "My Kindle Is The Side Piece.","I‚Äôm Booked Through Next Week.","I DNF People Too.","Shelf Control Issues."
      ],
      morally_gray: [
        "If He‚Äôs Wrong, I‚Äôm Worse.","Grace With Teeth.","Morals? Negotiable.","Pretty. Petty. Precise.","I‚Äôm Not Nice. I‚Äôm Necessary.",
        "Charm Is Tactical.","Mercy Is Optional.","I Play Long Games.","Soft Voice. Hard Consequences."
      ],
      unhinged_mmc: [
        "He‚Äôs Unstable. I‚Äôm Interested.","Mine. No Discussion.","Obsessed Is Romantic.","Touch Me & See.","He Doesn‚Äôt Share.",
        "Protective Looks Good.","He‚Äôd Burn Cities For Me.","Red Flags Are Decorative."
      ],
      street_lingo: [
        "Stand On Business.","Ten Toes. No Folding.","Don‚Äôt Play In My Face.","Clocked & Noted.","Say Less.",
        "Keep It Cute Or Keep It Moving.","Energy Expensive.","No Face. No Case.","Silent Moves. Loud Results."
      ],
      tropes: TROPE_LIBRARY,

      // GENRE FLAVORS
      urban_fiction: [
        "Ride Or Die Reads.","Love Loud. Move Quiet.","City-Lit Chemistry.","Pressure Make Diamonds.",
        "Hood Luxe, Soft Hands.","Don‚Äôt Fold On The Feelings."
      ],
      black_romance: [
        "Soft Love, Strong Boundaries.","Luxury Love Only.","Healed, But Still Don‚Äôt Try Me.","Love Me Correctly.",
        "Black Love, Big Energy.","Peace First, Passion Second."
      ],
      dark_romance: [
        "Sweet‚Ä¶ Until Midnight.","Danger Looks Good.","Tension Got A Grip On Me.","Bad Decisions, Great Chemistry.",
        "He‚Äôs A Problem. I‚Äôm Invested.","I Like It Dark And Devoted."
      ],
      black_paranormal: [
        "Ancestral Power Activated.","Moonlit & Dangerous.","My Aura Don‚Äôt Argue.","Spirit-Safe, But Still Spicy.",
        "Wards Up, Standards Higher.","Coven Chic Only."
      ],
      thriller: [
        "Trust No One.","Hidden In Plain Sight.","Smile. It‚Äôs Recorded.","Cold Case Energy.","Observe. Then Strike.",
        "Nothing Is Random.","Keep Your Eyes Open."
      ],
      fantasy: [
        "Spellbound & Sealed.","Summon At Midnight.","Divine & Dangerous.","Enchanted, Not Explained.",
        "Cursed In A Cute Way.","Fae Rules, My Terms."
      ],
      horror: [
        "No Sleep Club.","Creepy Cozy Reader.","I Read This Alone. Mistake.","If You Hear That‚Ä¶ Run.","The Plot Is Possessed.",
        "Lights On, Pages Turned.","Something‚Äôs In This Chapter.","This Book Took My Peace."
      ],
      bookish_luxe: [
        "Glossy Covers, Expensive Taste.","Quiet Luxury, Loud Standards.","Polished & Petty.","Champagne Chapters Only.",
        "Reader, But Make It Luxury."
      ],
      soft_glam_reader: [
        "Soft Glam, Sharp Mind.","Pretty Pages Only.","Cozy But Don‚Äôt Test Me.","Lip Gloss & Literature.",
        "Sweet Voice, Strong No."
      ],

      // vibe/format mini-banks (used when those vibes are selected; also used by random)
      mood_quotes: [
        "Mood: unbothered, booked.","Mood: in my chapter era.","Mood: expensive peace.","Mood: soft life only.",
        "Mood: don‚Äôt text‚Äîplotting."
      ],
      iykyk: [
        "IYKYK.","If you know, you know.","You had to be there.","The girls that get it, get it.","Insider plot only."
      ],
      audiobook: [
        "Audiobook on 1.5x.","Narrator got me blushing.","Headphones = boundaries.","If the audio hits, I‚Äôm gone."
      ],
      ruined_me_5stars: [
        "This book ruined me‚Ä¶ 5 stars.","Emotionally damaged‚Ä¶ 5 stars.","I‚Äôll never recover‚Ä¶ 5 stars.","Sobbing‚Ä¶ 5 stars."
      ],
      bookland: [
        "Remaining in Bookland until further notice.","Do not disturb: Bookland.","Out of office: Bookland.","Currently unavailable: Bookland."
      ],
      in_my_era: [
        "In my ‚Äòsoft but savage‚Äô era.","In my ‚Äòno new friends, just new books‚Äô era.","In my ‚Äòmain character‚Äô era.","In my ‚Äòmind my business‚Äô era."
      ],
      dbe: [
        "DBE: down bad energy‚Ä¶ 5 stars.","DBE: dangerously booked‚Ä¶ 5 stars.","DBE: delulu but disciplined‚Ä¶ 5 stars."
      ],
      slow_burn: [
        "Slow burn, fast heartbeat.","Slow burn season.","Worth the wait.","Tension is the point."
      ],
      stfuattdlagg: [
        "STFUATTDLAGG.","Say less. Turn the page.","Keep talking‚ÄîI'm reading.","Louder? I‚Äôm in chapter 23."
      ],
      ugly_cry: [
        "Ugly cry incoming.","Tissues required.","Crying but cute.","Sobbing in silence."
      ]
    };

    function wordCount(s){
      return (s||"").trim().split(/\s+/).filter(Boolean).length;
    }

    function customQuoteBank(){
      const raw = (v("customQuotes")||"").trim();
      if(!raw) return [];
      return raw.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
    }

    function selectedGenreBanks(){
      const map = [
        ["gUrbanFiction","urban_fiction"],
        ["gBlackRomance","black_romance"],
        ["gDarkRomance","dark_romance"],
        ["gBlackParanormal","black_paranormal"],
        ["gThriller","thriller"],
        ["gFantasy","fantasy"],
        ["gHorror","horror"],
        ["gBookishLuxe","bookish_luxe"],
        ["gSoftGlam","soft_glam_reader"]
      ];
      return map.filter(([id])=>c(id)).map(([,k])=>k);
    }

    function vibeKeyFromSelection(){
      const vv = ((v("customVibe")||"").trim() || v("vibe") || "").toLowerCase();
      if(!vv) return "";

      if(vv.includes("mood")) return "mood_quotes";
      if(vv.includes("iykyk")) return "iykyk";
      if(vv.includes("audiobook")) return "audiobook";
      if(vv.includes("ruined me")) return "ruined_me_5stars";
      if(vv.includes("bookland")) return "bookland";
      if(vv.includes("in my")) return "in_my_era";
      if(vv.includes("dbe")) return "dbe";
      if(vv.includes("slow burn")) return "slow_burn";
      if(vv.includes("stfuattdl")) return "stfuattdlagg";
      if(vv.includes("ugly cry")) return "ugly_cry";
      return "";
    }

    function buildQuotePool(){
      // 1) Custom quotes win
      const custom = customQuoteBank();
      if(custom.length) return custom;

      // 2) Base pool from selected core banks
      let pool = [];

      if(c("bGeneralUrbanBookish")) pool.push(...(QUOTE_BANKS.general_urban_bookish||[]));
      if(c("bTBRKindleBooktok")) pool.push(...(QUOTE_BANKS.tbr_kindle_booktok||[]));
      if(c("bMorallyGray")) pool.push(...(QUOTE_BANKS.morally_gray||[]));
      if(c("bUnhingedMMC")) pool.push(...(QUOTE_BANKS.unhinged_mmc||[]));
      if(c("bStreetLingo")) pool.push(...(QUOTE_BANKS.street_lingo||[]));
      if(c("bTropes")) pool.push(...(QUOTE_BANKS.tropes||[]));

      // 3) Add genre flavors (only if toggled)
      selectedGenreBanks().forEach(key=>{
        pool.push(...(QUOTE_BANKS[key]||[]));
      });

      // 4) If vibe implies a mini-bank, add it (doesn't count against your 1‚Äì2 bank picker, it's automatic flavor)
      const vk = vibeKeyFromSelection();
      if(vk) pool.push(...(QUOTE_BANKS[vk]||[]));

      // 5) Mode adds micro
      const qm = v("quoteMode");
      if(qm === "micro" || qm === "any") pool.push(...MICRO_QUOTES);

      pool = uniq(pool);

      // If nothing selected, fallback
      if(pool.length === 0){
        pool = uniq([...(QUOTE_BANKS.general_urban_bookish||[]), ...(QUOTE_BANKS.street_lingo||[]), ...MICRO_QUOTES]);
      }

      // If micro mode, strongly bias micro
      if(qm === "micro"){
        const micro = uniq([...MICRO_QUOTES]);
        return micro.length ? micro : pool;
      }

      return pool;
    }

    function chooseQuote(){
      const typed = (v("quote")||"").trim();
      if(typed) return typed;
      if(!c("useRandomQuote")) return "";
      const pool = buildQuotePool();
      return pool.length ? pick(pool) : "";
    }

    // ---------- Typography / spice ----------
    function typographyRuleText(){
      if(v("typoRule") !== "on") return "";
      return "clear legible typography, centered composition, bold high-contrast text, no distorted letters";
    }
    function spiceAesthetic(){
      const s = Number(v("spiceLevel") || 1);
      if(s<=1) return "spice aesthetic: sweet tension, soft charm, cozy flirt energy";
      if(s===2) return "spice aesthetic: playful chemistry, cheeky tension, cute-but-bold";
      if(s===3) return "spice aesthetic: spicy vibes, bold flirting, possessive undertones (non-graphic)";
      if(s===4) return "spice aesthetic: dark romance heat, intense chemistry, edgy tension (non-graphic)";
      return "spice aesthetic: filthy talk energy, power tension, ruthless chemistry (non-graphic)";
    }

    // ---------- Cut-safe instruction (applies to ALL accents) ----------
    function cutSafeText(){
      if(!c("cutSafeMode")) return "";
      return "Cut-safe die-cut requirement: one continuous closed silhouette outline around the ENTIRE design. All glow/sparkles/smoke/particles must stay INSIDE the silhouette boundary. No floating elements outside the border. No drifting aura; any glow must hug the silhouette tightly.";
    }
    function accentContainmentSuffix(){
      if(!c("cutSafeMode")) return "";
      return "(ALL accents/particles/glow fully contained INSIDE the silhouette; nothing outside the outline)";
    }

    // ---------- Visual finish ----------
    function finishText(){
      const outline = (v("outline")==="bold_black") ? "thick bold outline" : "no outline";
      const border = (v("border")==="white") ? "clean white sticker offset border" : "no sticker border";
      const bgMode = v("bgMode");
      const bg =
        (bgMode==="transparent") ? "transparent background" :
        (bgMode==="solid_white") ? "solid white background" : "background not specified";

      const varKey = v("variation");
      const varText = varKey ? (VARIATIONS[varKey] || "") : "";

      return [
        outline, border, bg, varText,
        "crisp edges, vector-like clarity",
        "high resolution",
        "no brand logos, no watermark"
      ].filter(Boolean).join(", ");
    }

    // ---------- Subject / label logic ----------
    function shouldIncludeQuoteLine(stickerType){
      const usage = v("quoteUsage"); // smart|always|never
      if(c("blankMode")) return false;
      if(usage === "never") return false;
      if(usage === "always") return true;

      if(stickerType === "icon_quote") return true;
      if(stickerType === "quote_only") return true;
      if(stickerType === "packaging") return false;
      return false;
    }

    function genreToneText(){
      const g = v("genreTone");
      if(!g) return "";
      return "genre tone: " + g.replaceAll("_"," ") + ".";
    }

    function vibeText(){
      const custom = (v("customVibe")||"").trim();
      const base = v("vibe");
      const vv = custom || base;
      return vv ? ("vibe: " + vv + ".") : "";
    }

    // ‚úÖ Harmony rule: if Horror and palette left blank, auto-pair red/black palette in prompt
    function paletteText(){
      const custom = (v("customPalette")||"").trim();
      const base = v("palette");
      let p = custom || base;

      if(!p && v("genreTone")==="horror"){
        p = pick(HORROR_PALETTES);
      }

      return p ? ("color palette: " + p + ".") : "";
    }

    function buildLabelTextBlock(stickerType, quote){
      if(c("blankMode")) return "No label text.";
      const mode = v("labelMode"); // none|auto|manual|mixed|quote_subtitle
      if(mode === "none") return "No label text.";
      if(stickerType !== "packaging" && v("productTheme")==="") return "";

      const manualTitle = (v("titleText")||"").trim();
      const manualSub = (v("subtitleText")||"").trim();

      const auto = getAutoLabel();
      const title = (mode==="manual") ? manualTitle :
                    (mode==="mixed") ? (manualTitle || auto.title) :
                    (mode==="quote_subtitle") ? (auto.title) :
                    (auto.title);

      const subtitle = (mode==="manual") ? manualSub :
                       (mode==="mixed") ? (manualSub || auto.subtitle) :
                       (mode==="quote_subtitle") ? (quote || auto.subtitle) :
                       (auto.subtitle);

      if(mode==="manual" && !title && !subtitle) return "No label text.";

      return `Label text (packaging-style): title ‚Äú${title}‚Äù${subtitle ? `, subtitle ‚Äú${subtitle}‚Äù` : ""}.`;
    }

    function mainSubjectText(){
      const customObj = (v("customMainObject")||"").trim();
      const product = describeProductKey();
      const stickerType = v("stickerType");

      if(stickerType === "packaging" || product){
        return `Main subject: ${product || "packaging-style sticker illustration with clean label panel"}` + (customObj ? `, featuring ${customObj}` : "") + ".";
      }

      if(customObj) return `Main subject: ${customObj}.`;
      return "Main subject: simple iconic bookish symbol.";
    }

    function accentsText(){
      const userAcc = (v("customAccents")||"").trim();
      const key = v("productTheme");
      const defaultAcc = DEFAULT_ACCENTS_BY_PRODUCT[key] || "";
      const combined = [userAcc, defaultAcc].filter(Boolean).join(" + ");
      if(!combined) return "";
      return `add accents: ${combined} ${accentContainmentSuffix()}.`;
    }

    // ---------- Prompt assembly ----------
    function buildPromptSingle(){
      const stickerType = v("stickerType");
      const quote = chooseQuote();
      const typo = typographyRuleText();
      const safety = "original design, no trademarks, no brand names, no copyrighted characters";

      const quoteLine = (quote && shouldIncludeQuoteLine(stickerType))
        ? `Optional quote line: ‚Äú${quote}‚Äù.`
        : "";

      const labelTextBlock = buildLabelTextBlock(stickerType, quote);

      const labelPanelNote = (stickerType === "packaging" || v("productTheme") || (v("customProductTheme")||"").trim())
        ? "Include a clean label panel area for text, centered layout, readable hierarchy."
        : "";

      const cutSafe = cutSafeText();
      const blankLine = c("blankMode") ? "No text at all (blank sticker mode)." : "";

      // product theme readable text
      const pt = ((v("customProductTheme")||"").trim())
        ? (v("customProductTheme")||"").trim()
        : (v("productTheme") ? v("productTheme").replaceAll("_"," ") : "None");

      return [
        "Create image:",
        finishText() + ".",
        cutSafe,
        paletteText(),
        genreToneText(),
        vibeText(),
        spiceAesthetic() + ".",
        "Product theme: " + pt + ".",
        mainSubjectText(),
        accentsText(),
        typo ? ("Typography: " + typo + ".") : "",
        labelPanelNote,
        labelTextBlock,
        quoteLine,
        blankLine,
        safety + ".",
        "Clean commercial sticker clipart look, polished, readable, centered."
      ].filter(Boolean).join(" ");
    }

    function buildBundle(){
      const n = Math.max(1, Math.min(5, parseInt(v("count"),10) || 1));
      const out = [];
      for(let i=0;i<n;i++){
        out.push(`Prompt ${i+1}:\n${buildPromptSingle()}`);
      }

      const negative =
        "photorealistic, blurry, low-res, messy outline, uneven line weight, distorted letters, unreadable text, random extra words, watermark, signature, brand logos, copyrighted characters, celebrity likeness, background scene, floating particles outside outline, aura outside silhouette, UI elements";

      const notes =
`Export notes:
- Best: PNG
- Background: Transparent (recommended for stickers)
- Size: 2000‚Äì3000px

Cut-safe:
- When ON: forces a single closed die-cut silhouette + keeps ALL accents inside.

Harmony:
- Horror + no palette selected => auto-bias to red/black palettes.

Label logic:
- Label Mode controls title/subtitle.
- Blank mode removes all text instructions.`;

      return { body: out.join("\n\n"), negative, notes };
    }

    function generate(){
      try{
        const { body, negative, notes } = buildBundle();
        setV("promptOut", body);
        setV("negOut", negative);
        setV("notesOut", notes);
        setStatus("Generated ‚úÖ");
        setTimeout(()=>setStatus("Ready"), 900);
      } catch(e){
        setV("promptOut", "‚ùå Generator error:\n" + (e?.message || e));
        setStatus("Error ‚ùå");
        showToast("Error ‚Äî check Prompt box");
      }
    }

    async function copyPrompt(){
      const text = (v("promptOut")||"").trim();
      if(!text){ showToast("Generate first"); return; }
      try{
        await navigator.clipboard.writeText(text);
        showToast("Copied");
      } catch{
        const ta = $("promptOut");
        ta.focus(); ta.select();
        document.execCommand("copy");
        showToast("Copied");
      }
    }

    // ---------- Hand-drawn preset toggle ----------
    function applyHandDrawnPreset(){
      if(!$("handDrawnPreset")) return;

      if(c("handDrawnPreset")){
        setV("variation","hand_drawn");
        setV("outline","bold_black");
        setV("border","white");
        if(v("bgMode")==="none_specified") setV("bgMode","transparent");
        setV("typoRule","on");
      }
    }

    // ---------- Randomize (picks 1‚Äì2 quote banks max, ALWAYS sensible) ----------
    const CORE_BANK_IDS = ["bGeneralUrbanBookish","bTBRKindleBooktok","bMorallyGray","bUnhingedMMC","bStreetLingo","bTropes"];
    const GENRE_BANK_IDS = ["gUrbanFiction","gBlackRomance","gDarkRomance","gBlackParanormal","gThriller","gFantasy","gHorror","gBookishLuxe","gSoftGlam"];

    function uncheckAll(ids){ ids.forEach(id=>{ if($(id)) $(id).checked = false; }); }

    function pickOneOrTwo(ids){
      uncheckAll(ids);
      const pickCount = Math.random() < 0.55 ? 1 : 2;
      const shuffled = [...ids].sort(()=>Math.random()-0.5);
      shuffled.slice(0, pickCount).forEach(id=> setC(id,true));
    }

    function randomize(){
      setV("count", String(pick(["1","2","3"])));
      setV("stickerType", pick(["packaging","icon_quote","icon_only","quote_only"]));

      setC("cutSafeMode", true);

      // genre tone (now includes horror)
      const g = pick(["urban_fiction","dark_romance","black_paranormal","black_romance","thriller","fantasy","horror","soft_glam_reader","bookish_luxe",""]);
      setV("genreTone", g);

      // vibe
      setV("vibe", pick(Array.from($("vibe").options).map(o=>o.value).filter(x=>x!=="" && x!=="None")));

      // variation (bias hand_drawn sometimes)
      const varPick = pick(["booktok_pop","bold_vector","luxury_editorial","neon_noir","noir_minimal","hand_doodle","hand_drawn","cute_clipart","vintage_label","kawaii_goth",""]);
      setV("variation", varPick);
      setC("handDrawnPreset", varPick==="hand_drawn");

      // product theme (expanded)
      const PACKAGING_PRODUCTS = [
        "iv_bag","pill_bottle","prescription_pad","heart_monitor","toe_tag",
        "seasoning","hot_sauce","honey_jar","juice_bottle","energy_drink","candy",
        "door_tag","name_tag","library_card","guest_check","tbr_receipt",
        "spice_meter","delulu_meter","ugly_cry_meter","horror_scale",
        "caution_sign","phone_dnd","sticky_memos","fortune_cookie","magic_8_ball","glass_fortune_ball",
        "bp_monitor","book_review_card","elixir_bottle","wax_seal_stamp","candle_spell_jar","matchbook",
        "polaroid_frame","nail_polish","coffee_cup","specimen_vial","evidence_tag","tarot_card",
        "bookmark_sneaker_lace","book_stack_tropes","confession_note"
      ];

      if(v("stickerType")==="packaging"){
        setV("productTheme", pick(PACKAGING_PRODUCTS));
      } else {
        setV("productTheme", Math.random()<0.45 ? pick(["iv_bag","tbr_receipt","book_review_card","coffee_cup","sticky_memos","book_stack_tropes",""]) : "");
      }

      // palette harmony
      if(g==="horror"){
        setV("palette", pick(["", ...HORROR_PALETTES])); // allow blank so harmony can fill
      } else {
        setV("palette", pick(["", ...PALETTES]));
      }

      setV("bgMode", pick(["transparent","solid_white","transparent"]));
      setV("spiceLevel", pick(["1","2","3","4","5"]));

      setV("labelMode", v("stickerType")==="packaging" ? pick(["auto","mixed","none","quote_subtitle"]) : "none");
      setC("blankMode", v("stickerType")==="icon_only" ? (Math.random()<0.25) : false);

      // banks: pick 1‚Äì2 core, 1‚Äì2 genre
      pickOneOrTwo(CORE_BANK_IDS);
      if(Math.random()<0.55) pickOneOrTwo(GENRE_BANK_IDS); else uncheckAll(GENRE_BANK_IDS);

      setC("useRandomQuote", !c("blankMode"));

      // clear overrides
      setV("titleText","");
      setV("subtitleText","");
      setV("quote","");
      setV("customMainObject","");
      setV("customVibe","");
      setV("customPalette","");
      setV("customAccents","");
      setV("customProductTheme","");
      setV("customQuotes","");

      applyHandDrawnPreset();
      generate();
      showToast("Randomized (1‚Äì2 banks max)");
    }

    function clearAll(){
      setV("count","3");
      setV("stickerType","packaging");
      setV("genreTone","");
      setV("variation","");
      setC("handDrawnPreset", false);
      setV("vibe","");
      setV("productTheme","");
      setV("palette","");
      setV("bgMode","transparent");
      setV("border","white");
      setV("outline","bold_black");
      setV("spiceLevel","3");
      setV("typoRule","on");

      setC("blankMode", false);
      setC("cutSafeMode", true);
      setV("labelMode","auto");

      setC("useRandomQuote", true);
      setV("quoteUsage","smart");
      setV("quote","");
      setV("titleText","");
      setV("subtitleText","");

      setV("customMainObject","");
      setV("customVibe","");
      setV("customPalette","");
      setV("customAccents","");
      setV("customProductTheme","");
      setV("customQuotes","");

      uncheckAll(CORE_BANK_IDS);
      setC("bGeneralUrbanBookish", true);
      uncheckAll(GENRE_BANK_IDS);

      setV("promptOut","");
      setV("negOut","");
      setV("notesOut","");

      setStatus("Ready");
      showToast("Cleared");
    }

    // ---------- Init ----------
    loadPalettes();

    $("generateBtn").addEventListener("click", ()=>{ applyHandDrawnPreset(); generate(); });
    $("copyBtn").addEventListener("click", copyPrompt);
    $("randomBtn").addEventListener("click", randomize);
    $("clearBtn").addEventListener("click", clearAll);

    // react to preset toggle immediately
    $("handDrawnPreset").addEventListener("change", ()=>{
      applyHandDrawnPreset();
      generate();
    });

    window.addEventListener("load", ()=>{
      setC("cutSafeMode", true);
      setC("bGeneralUrbanBookish", true);
      generate();
    });
  </script>
</body>
</html>
